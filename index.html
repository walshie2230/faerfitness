<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fær Fitness Programs</title>
  <script type="text/javascript" src="https://sdk.userbase.com/2/userbase.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #container {
      width: 90%;
      max-width: 600px;
      background: white;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      text-align: center;
    }
    h1 {
      margin-bottom: 20px;
      color: #1a73e8;
    }
    form {
      margin-bottom: 20px;
    }
    input[type="text"], input[type="password"], input[type="submit"] {
      width: calc(100% - 20px);
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    input[type="submit"] {
      background-color: #1a73e8;
      color: white;
      border: none;
      cursor: pointer;
    }
    input[type="submit"]:hover {
      background-color: #1558b1;
    }
    #loading-view, #auth-view, #content-view, #payment-view {
      display: none;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      background-color: #1a73e8;
      color: white;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #1558b1;
    }
    iframe {
      width: 100%;
      height: 70vh;
      border: none;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="loading-view">Loading...</div>

    <div id="auth-view">
      <h1>Login</h1>
      <form id="login-form">
        <input id="login-username" type="text" required placeholder="Username">
        <input id="login-password" type="password" required placeholder="Password">
        <input type="submit" value="Sign in">
      </form>
      <div id="login-error" style="color: red;"></div>

      <h1>Create an Account</h1>
      <form id="signup-form">
        <input id="signup-username" type="text" required placeholder="Username">
        <input id="signup-password" type="password" required placeholder="Password">
        <input type="submit" value="Create an Account">
      </form>
      <div id="signup-error" style="color: red;"></div>
    </div>

    <div id="payment-view">
      <h1>Subscribe to Premium</h1>
      <p>To access premium content, please subscribe.</p>
      <button id="checkout-button">Subscribe Now</button>
      <div id="payment-error" style="color: red;"></div>
    </div>

    <div id="content-view">
      <span id="username"></span>
      <input type="button" value="Logout" id="logout-button" style="margin-bottom: 20px;">
      <h1>Fær Fitness Programs</h1>
      <iframe id="content"></iframe>
    </div>
  </div>

  <script type="text/javascript">
    const stripe = Stripe('pk_live_51PczKiAGtSRmBjZCK2e7k0izxR7EnEiHToYUaj91lgMkiAToRVpqZZpKLhg0PFoUzZKxW1PDcIPL7vLOI22tZRML00i7UoyNlC'); // Replace with your Stripe publishable key

    userbase.init({ appId: '123eaf93-2d9d-481a-a937-b58a4f5aecd1' })
      .then((session) => {
        if (session.user) {
          showContent(session.user)
        } else {
          showAuth()
        }
      })
      .catch(() => showAuth())
      .finally(() => document.getElementById('loading-view').style.display = 'none');

    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;

      userbase.signIn({ username, password, rememberMe: 'local' })
        .then((user) => showContent(user))
        .catch((e) => document.getElementById('login-error').innerText = e.message);
    }

    function handleSignUp(e) {
      e.preventDefault();
      const username = document.getElementById('signup-username').value;
      const password = document.getElementById('signup-password').value;

      userbase.signUp({ username, password, rememberMe: 'local' })
        .then((user) => showContent(user))
        .catch((e) => document.getElementById('signup-error').innerText = e.message);
    }

    function handleLogout() {
      userbase.signOut()
        .then(() => showAuth())
        .catch((e) => document.getElementById('logout-error').innerText = e.message);
    }

    function showContent(user) {
      document.getElementById('auth-view').style.display = 'none';
      document.getElementById('content-view').style.display = 'none';
      document.getElementById('payment-view').style.display = 'none';

      if (user.profile && user.profile.subscription === 'premium') {
        document.getElementById('content-view').style.display = 'block';
        document.getElementById('username').innerText = `Welcome, ${user.username}`;
        document.getElementById('content').src = 'https://faerfit.notion.site/Welcome-to-The-FAER-Fitness-Dojo-838ee4a7a671448facae3befb5b29b85?pvs=4';
      } else {
        document.getElementById('payment-view').style.display = 'block';
      }
    }

    function showAuth() {
      document.getElementById('content-view').style.display = 'none';
      document.getElementById('payment-view').style.display = 'none';
      document.getElementById('auth-view').style.display = 'block';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('login-error').innerText = '';
      document.getElementById('signup-username').value = '';
      document.getElementById('signup-password').value = '';
      document.getElementById('signup-error').innerText = '';
    }

    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('signup-form').addEventListener('submit', handleSignUp);
    document.getElementById('logout-button').addEventListener('click', handleLogout);

    document.getElementById('checkout-button').addEventListener('click', async () => {
      const response = await fetch('/api/create-checkout-session', {
        method: 'POST',
      });
      const session = await response.json();

      stripe.redirectToCheckout({ sessionId: session.id }).then((result) => {
        if (result.error) {
          document.getElementById('payment-error').innerText = result.error.message;
        }
      });
    });

    // Function to update user profile after successful payment
    async function updateUserToPremium(userId) {
      await userbase.updateUser({ profile: { subscription: 'premium' } })
        .then(() => {
          // Reload the content view to reflect the premium status
          showContent(userbase.getCurrentSession().user);
        })
        .catch((e) => {
          console.error('Error updating user profile:', e);
        });
    }
  </script>
</body>
</html>
